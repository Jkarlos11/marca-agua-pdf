<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marca de Agua para PDFs</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Gothic+A1:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Iconos SVG
        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const FileText = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
        );

        const Droplets = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
            </svg>
        );

        const Settings = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const Trash2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const Eye = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
        );

        const CheckCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        function PDFWatermarkTool() {
            const [files, setFiles] = useState([]);
            const [watermarkText, setWatermarkText] = useState('CONFIDENCIAL');
            const [fontSize, setFontSize] = useState(50);
            const [color, setColor] = useState('#FF0000');
            const [opacity, setOpacity] = useState(0.3);
            const [rotation, setRotation] = useState(-45);
            const [position, setPosition] = useState('center');
            const [fontFamily, setFontFamily] = useState('Helvetica');
            const [processing, setProcessing] = useState(false);
            const [pdfLibLoaded, setPdfLibLoaded] = useState(false);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [showPreview, setShowPreview] = useState(false);
            const [previewGenerated, setPreviewGenerated] = useState(false);
            const [processedPdfs, setProcessedPdfs] = useState([]);

            useEffect(() => {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js';
                script.async = true;
                script.onload = () => {
                    console.log('PDF-lib cargado correctamente');
                    setPdfLibLoaded(true);
                };
                script.onerror = () => {
                    console.error('Error al cargar PDF-lib');
                    alert('Error al cargar la librería PDF. Por favor recarga la página.');
                };
                document.body.appendChild(script);

                return () => {
                    if (document.body.contains(script)) {
                        document.body.removeChild(script);
                    }
                };
            }, []);

            useEffect(() => {
                if (previewUrl) {
                    URL.revokeObjectURL(previewUrl);
                }
                setPreviewGenerated(false);
            }, [watermarkText, fontSize, color, opacity, rotation, position, fontFamily]);

            const handleFileUpload = (e) => {
                const newFiles = Array.from(e.target.files).filter(f => f.type === 'application/pdf');
                if (files.length + newFiles.length > 10) {
                    alert('Máximo 10 archivos permitidos');
                    return;
                }
                setFiles([...files, ...newFiles.slice(0, 10 - files.length)]);
                setPreviewGenerated(false);
                setShowPreview(false);
                setProcessedPdfs([]);
            };

            const removeFile = (index) => {
                setFiles(files.filter((_, i) => i !== index));
                setPreviewGenerated(false);
                setShowPreview(false);
            };

            const getPositionCoordinates = (width, height, pos) => {
                switch(pos) {
                    case 'center': return { x: width / 2, y: height / 2 };
                    case 'top-left': return { x: 100, y: height - 100 };
                    case 'top-right': return { x: width - 100, y: height - 100 };
                    case 'bottom-left': return { x: 100, y: 100 };
                    case 'bottom-right': return { x: width - 100, y: 100 };
                    default: return { x: width / 2, y: height / 2 };
                }
            };

            const hexToRgb = (hex) => {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16) / 255,
                    g: parseInt(result[2], 16) / 255,
                    b: parseInt(result[3], 16) / 255
                } : { r: 1, g: 0, b: 0 };
            };

            const embedCustomFont = async (pdfDoc, fontName) => {
                const { StandardFonts } = window.PDFLib;
                
                if (fontName === 'Century-Gothic') {
                    return await pdfDoc.embedFont(StandardFonts.Helvetica);
                }
                
                switch(fontName) {
                    case 'Courier':
                        return await pdfDoc.embedFont(StandardFonts.Courier);
                    case 'Times-Roman':
                        return await pdfDoc.embedFont(StandardFonts.TimesRoman);
                    case 'Helvetica-Bold':
                        return await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                    default:
                        return await pdfDoc.embedFont(StandardFonts.Helvetica);
                }
            };

            const generatePreview = async () => {
                if (files.length === 0) {
                    alert('Por favor, carga al menos un archivo PDF');
                    return;
                }
                if (!watermarkText.trim()) {
                    alert('Por favor, ingresa el texto de la marca de agua');
                    return;
                }
                if (!pdfLibLoaded) {
                    alert('Cargando librería PDF... Por favor espera un momento e intenta de nuevo.');
                    return;
                }

                setProcessing(true);

                try {
                    const { PDFDocument, rgb, degrees } = window.PDFLib;
                    
                    const file = files[0];
                    const arrayBuffer = await file.arrayBuffer();
                    const pdfDoc = await PDFDocument.load(arrayBuffer);
                    
                    const font = await embedCustomFont(pdfDoc, fontFamily);
                    
                    const pages = pdfDoc.getPages();
                    const firstPage = pages[0];
                    const { width, height } = firstPage.getSize();
                    const { x, y } = getPositionCoordinates(width, height, position);
                    const colorRgb = hexToRgb(color);
                    
                    const textWidth = font.widthOfTextAtSize(watermarkText, fontSize);
                    const textHeight = font.heightAtSize(fontSize);
                    
                    let finalX = x;
                    let finalY = y;
                    
                    if (position === 'center') {
                        finalX = x - textWidth / 2;
                        finalY = y - textHeight / 2;
                    } else if (position.includes('right')) {
                        finalX = x - textWidth;
                    }
                    
                    firstPage.drawText(watermarkText, {
                        x: finalX,
                        y: finalY,
                        size: fontSize,
                        font: font,
                        color: rgb(colorRgb.r, colorRgb.g, colorRgb.b),
                        opacity: opacity,
                        rotate: degrees(rotation),
                    });
                    
                    const pdfBytes = await pdfDoc.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    
                    if (previewUrl) {
                        URL.revokeObjectURL(previewUrl);
                    }
                    
                    setPreviewUrl(url);
                    setShowPreview(true);
                    setPreviewGenerated(true);
                    
                } catch (error) {
                    console.error('Error completo:', error);
                    alert(`Error al generar la vista previa: ${error.message}`);
                } finally {
                    setProcessing(false);
                }
            };

            const processAllFiles = async () => {
                if (files.length === 0) {
                    alert('Por favor, carga al menos un archivo PDF');
                    return;
                }
                if (!previewGenerated) {
                    alert('Por favor, genera y aprueba la vista previa primero');
                    return;
                }

                setProcessing(true);
                const processed = [];

                try {
                    const { PDFDocument, rgb, degrees } = window.PDFLib;
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        console.log(`Procesando archivo ${i + 1}/${files.length}: ${file.name}`);
                        
                        const arrayBuffer = await file.arrayBuffer();
                        const pdfDoc = await PDFDocument.load(arrayBuffer);
                        
                        const font = await embedCustomFont(pdfDoc, fontFamily);
                        
                        const pages = pdfDoc.getPages();
                        const colorRgb = hexToRgb(color);
                        
                        for (const page of pages) {
                            const { width, height } = page.getSize();
                            const { x, y } = getPositionCoordinates(width, height, position);
                            
                            const textWidth = font.widthOfTextAtSize(watermarkText, fontSize);
                            const textHeight = font.heightAtSize(fontSize);
                            
                            let finalX = x;
                            let finalY = y;
                            
                            if (position === 'center') {
                                finalX = x - textWidth / 2;
                                finalY = y - textHeight / 2;
                            } else if (position.includes('right')) {
                                finalX = x - textWidth;
                            }
                            
                            page.drawText(watermarkText, {
                                x: finalX,
                                y: finalY,
                                size: fontSize,
                                font: font,
                                color: rgb(colorRgb.r, colorRgb.g, colorRgb.b),
                                opacity: opacity,
                                rotate: degrees(rotation),
                            });
                        }
                        
                        const pdfBytes = await pdfDoc.save();
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const url = URL.createObjectURL(blob);
                        
                        processed.push({
                            name: `watermarked_${file.name}`,
                            url: url,
                            blob: blob
                        });
                    }
                    
                    setProcessedPdfs(processed);
                    alert(`¡${files.length} archivo(s) procesado(s) exitosamente! Ahora puedes descargar cada uno.`);
                    
                } catch (error) {
                    console.error('Error completo:', error);
                    alert(`Error al procesar los archivos: ${error.message}`);
                } finally {
                    setProcessing(false);
                }
            };

            const downloadFile = (fileData) => {
                const link = document.createElement('a');
                link.href = fileData.url;
                link.download = fileData.name;
                link.setAttribute('download', fileData.name);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const downloadAll = () => {
                if (processedPdfs.length === 0) return;
                
                processedPdfs.forEach((file, index) => {
                    setTimeout(() => {
                        downloadFile(file);
                    }, index * 300);
                });
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-2xl overflow-hidden">
                            <div className="bg-gradient-to-r from-blue-600 to-indigo-600 p-6">
                                <div className="flex items-center gap-3">
                                    <Droplets className="w-8 h-8 text-white" />
                                    <h1 className="text-2xl md:text-3xl font-bold text-white">Marca de Agua para PDFs</h1>
                                </div>
                                <p className="text-blue-100 mt-2">Agrega marcas de agua personalizadas a tus documentos PDF</p>
                                {!pdfLibLoaded && (
                                    <p className="text-yellow-200 mt-2 text-sm">⏳ Cargando librería PDF...</p>
                                )}
                            </div>

                            <div className="p-4 md:p-8">
                                <div className="grid lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-1">
                                        <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                                            <Upload className="w-5 h-5" />
                                            Archivos PDF
                                        </h2>
                                        
                                        <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-blue-300 rounded-xl cursor-pointer hover:bg-blue-50 transition-all">
                                            <Upload className="w-10 h-10 text-blue-500 mb-2" />
                                            <span className="text-sm text-gray-600">Cargar PDFs</span>
                                            <span className="text-xs text-gray-400 mt-1">Máx. 10 archivos</span>
                                            <input
                                                type="file"
                                                multiple
                                                accept=".pdf,application/pdf"
                                                onChange={handleFileUpload}
                                                className="hidden"
                                            />
                                        </label>

                                        <div className="mt-4 space-y-2 max-h-96 overflow-y-auto">
                                            {files.map((file, index) => (
                                                <div key={index} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                                    <div className="flex items-center gap-2 flex-1 min-w-0">
                                                        <FileText className="w-4 h-4 text-red-500 flex-shrink-0" />
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-sm truncate">{file.name}</p>
                                                            <p className="text-xs text-gray-400">
                                                                {(file.size / 1024).toFixed(1)} KB
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => removeFile(index)}
                                                        className="text-red-500 hover:text-red-700 ml-2 flex-shrink-0"
                                                    >
                                                        <Trash2 className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>

                                        {processedPdfs.length > 0 && (
                                            <div className="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                                                <h3 className="font-semibold text-green-900 mb-3 flex items-center gap-2">
                                                    <CheckCircle className="w-5 h-5" />
                                                    Archivos Procesados
                                                </h3>
                                                <div className="space-y-2 mb-4">
                                                    {processedPdfs.map((file, index) => (
                                                        <div key={index} className="flex items-center justify-between bg-white p-2 rounded">
                                                            <span className="text-sm truncate flex-1">{file.name}</span>
                                                            <button
                                                                onClick={() => downloadFile(file)}
                                                                className="ml-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 flex items-center gap-1"
                                                            >
                                                                <Download className="w-3 h-3" />
                                                                Bajar
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                                <button
                                                    onClick={downloadAll}
                                                    className="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 flex items-center justify-center gap-2"
                                                >
                                                    <Download className="w-4 h-4" />
                                                    Descargar Todos
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <div className="lg:col-span-1">
                                        <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
                                            <Settings className="w-5 h-5" />
                                            Configuración
                                        </h2>

                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Texto de la Marca de Agua
                                                </label>
                                                <input
                                                    type="text"
                                                    value={watermarkText}
                                                    onChange={(e) => setWatermarkText(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                    placeholder="Ej: CONFIDENCIAL"
                                                />
                                            </div>

                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Tamaño ({fontSize}px)
                                                    </label>
                                                    <input
                                                        type="range"
                                                        min="20"
                                                        max="150"
                                                        value={fontSize}
                                                        onChange={(e) => setFontSize(Number(e.target.value))}
                                                        className="w-full"
                                                    />
                                                </div>

                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                                        Opacidad ({Math.round(opacity * 100)}%)
                                                    </label>
                                                    <input
                                                        type="range"
                                                        min="0.1"
                                                        max="1"
                                                        step="0.1"
                                                        value={opacity}
                                                        onChange={(e) => setOpacity(Number(e.target.value))}
                                                        className="w-full"
                                                    />
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Rotación ({rotation}°)
                                                </label>
                                                <input
                                                    type="range"
                                                    min="-90"
                                                    max="90"
                                                    value={rotation}
                                                    onChange={(e) => setRotation(Number(e.target.value))}
                                                    className="w-full"
                                                />
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Color
                                                </label>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="color"
                                                        value={color}
                                                        onChange={(e) => setColor(e.target.value)}
                                                        className="h-10 w-20 cursor-pointer rounded"
                                                    />
                                                    <input
                                                        type="text"
                                                        value={color}
                                                        onChange={(e) => setColor(e.target.value)}
                                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                                                    />
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Posición
                                                </label>
                                                <select
                                                    value={position}
                                                    onChange={(e) => setPosition(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                >
                                                    <option value="center">Centro</option>
                                                    <option value="top-left">Superior Izquierda</option>
                                                    <option value="top-right">Superior Derecha</option>
                                                    <option value="bottom-left">Inferior Izquierda</option>
                                                    <option value="bottom-right">Inferior Derecha</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                                    Fuente
                                                </label>
                                                <select
                                                    value={fontFamily}
                                                    onChange={(e) => setFontFamily(e.target.value)}
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                >
                                                    <option value="Century-Gothic">Century Gothic</option>
                                                    <option value="Helvetica">Helvetica</option>
                                                    <option value="Helvetica-Bold">Helvetica Bold</option>
                                                    <option value="Times-Roman">Times New Roman</option>
                                                    <option value="Courier">Courier</option>
                                                </select>
                                            </div>

                                            <div className="p-3 bg-blue-50 rounded-lg border border-blue-200">
                                                <h3 className="font-semibold text-blue-900 mb-2 text-sm">Vista Previa:</h3>
                                                <div 
                                                    className="text-center py-4 overflow-hidden"
                                                    style={{
                                                        color: color,
                                                        fontSize: `${Math.min(fontSize / 3, 30)}px`,
                                                        opacity: opacity,
                                                        transform: `rotate(${rotation}deg)`,
                                                        fontFamily: fontFamily === 'Century-Gothic' ? 'Gothic A1, sans-serif' : fontFamily === 'Times-Roman' ? 'Times New Roman' : fontFamily
                                                    }}
                                                >
                                                    {watermarkText || 'Tu marca de agua'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>